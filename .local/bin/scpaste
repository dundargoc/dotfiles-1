#!/usr/bin/env python3

import re
import subprocess
import sys
import tempfile
from pathlib import Path

SSH_SERVER = "p.gpanders.com:scpaste"
HTTP_SERVER = "https://p.gpanders.com"
THEME = "edit-bbedit"
FONT = "Menlo, Consolas, Monaco, Liberation Mono, Lucida Console, monospace"
FONT_SIZE = "0.9rem"


def main(name, extra):
    if name is None:
        for arg in extra:
            p = Path(arg)
            if p.exists():
                name = p.name
                break
        else:
            name = input("Name: ")
            if name == "":
                print("Name is required", file=sys.stderr)
                sys.exit(1)

    args = [
        "highlight",
        "--anchors",
        "--out-format=html",
        "--include-style",
        "--line-numbers",
        f"--style={THEME}",
        f"--font={FONT}",
        f"--doc-title={name}",
        *extra,
    ]

    with tempfile.NamedTemporaryFile() as tmp:
        try:
            proc = subprocess.run(args, stdin=sys.stdin, capture_output=True)
            if proc.returncode != 0:
                sys.stderr.write(proc.stderr.decode())
                sys.exit(1)

            out = re.sub(r"\b(font-size):[^;]+;", rf"\1:{FONT_SIZE};", proc.stdout.decode())
            tmp.write(out.encode())

            subprocess.run(
                ["scp", tmp.name, f"{SSH_SERVER}/{name}.html"],
                check=True,
                capture_output=True,
            )

            print(f"{HTTP_SERVER}/{name}.html")
        except FileNotFoundError:
            print("highlight must be installed", file=sys.stderr)
            sys.exit(1)


if __name__ == "__main__":
    import argparse

    parser = argparse.ArgumentParser()
    parser.add_argument(
        "-n",
        dest="name",
        required=(not sys.stdin.isatty()),
        help="Name of the paste. Required if reading from stdin",
    )
    args, extra = parser.parse_known_args()
    main(args.name, extra)
